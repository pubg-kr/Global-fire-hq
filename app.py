import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
from datetime import datetime

# --- ÌéòÏù¥ÏßÄ ÏÑ§Ï†ï (Î™®Î∞îÏùº ÏπúÌôîÏ†Å) ---
st.set_page_config(page_title="Global Fire HQ", page_icon="üî•", layout="wide")

# --- Ïä§ÌÉÄÏùº Ïª§Ïä§ÌÖÄ ---
st.markdown("""
    <style>
        .metric-container {
                background-color: #1E1E1E;
                        padding: 15px;
                                border-radius: 10px;
                                        border: 1px solid #333;
                                                text-align: center;
                                                    }
                                                        .big-text { font-size: 20px; font-weight: bold; color: #ffffff; }
                                                            .sub-text { font-size: 14px; color: #aaaaaa; }
                                                                </style>
                                                                    """, unsafe_allow_html=True)

                                                                    # --- Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ìï®Ïàò ---
                                                                    @st.cache_data(ttl=300) # 5Î∂Ñ Ï∫êÏã±
                                                                    def get_data():
                                                                        # TQQQ, QQQ, ÌôòÏú®(KRW=X) ÎèôÏãú Ìò∏Ï∂ú
                                                                            tickers = ["TQQQ", "QQQ", "KRW=X"]
                                                                                data = yf.download(tickers, period="2y", interval="1wk", progress=False)
                                                                                    
                                                                                        # Ïª¨Îüº Î†àÎ≤® Ï†ïÎ¶¨ (MultiIndex Ìï¥Ï†ú)
                                                                                            if isinstance(data.columns, pd.MultiIndex):
                                                                                                    df = data['Close']
                                                                                                        else:
                                                                                                                df = data
                                                                                                                        
                                                                                                                            return df

                                                                                                                            # --- RSI Í≥ÑÏÇ∞ (Ï£ºÎ¥â 14) ---
                                                                                                                            def calculate_rsi(series, period=14):
                                                                                                                                delta = series.diff()
                                                                                                                                    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
                                                                                                                                        loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
                                                                                                                                            rs = gain / loss
                                                                                                                                                return 100 - (100 / (1 + rs))

                                                                                                                                                def main():
                                                                                                                                                    st.title("üî• PROJECT GLOBAL FIRE: Command Center")
                                                                                                                                                        st.markdown(f"**Ver 9.1 Protocol** | Date: {datetime.now().strftime('%Y-%m-%d')}")

                                                                                                                                                            with st.spinner('üõ∞Ô∏è ÏúÑÏÑ± Îç∞Ïù¥ÌÑ∞ ÏàòÏã† Ï§ë... (Market Data)'):
                                                                                                                                                                    df = get_data()

                                                                                                                                                                        if df is not None:
                                                                                                                                                                                # 1. Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú Î∞è Í∞ÄÍ≥µ
                                                                                                                                                                                        # TQQQ
                                                                                                                                                                                                tqqq_now = df['TQQQ'].iloc[-1]
                                                                                                                                                                                                        tqqq_prev = df['TQQQ'].iloc[-2]
                                                                                                                                                                                                                tqqq_chg = ((tqqq_now - tqqq_prev) / tqqq_prev) * 100
                                                                                                                                                                                                                        
                                                                                                                                                                                                                                # MDD (ÏµúÍ∑º 52Ï£º Í≥†Ï†ê ÎåÄÎπÑ)
                                                                                                                                                                                                                                        tqqq_52w = df['TQQQ'].tail(52)
                                                                                                                                                                                                                                                tqqq_high = tqqq_52w.max()
                                                                                                                                                                                                                                                        mdd = ((tqqq_now - tqqq_high) / tqqq_high) * 100
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        # RSI (Ï£ºÎ¥â)
                                                                                                                                                                                                                                                                                rsi_series = calculate_rsi(df['TQQQ'])
                                                                                                                                                                                                                                                                                        rsi_now = rsi_series.iloc[-1]

                                                                                                                                                                                                                                                                                                # ÌôòÏú®
                                                                                                                                                                                                                                                                                                        usd_krw = df['KRW=X'].iloc[-1]

                                                                                                                                                                                                                                                                                                                # 2. ÎåÄÏãúÎ≥¥Îìú UI Íµ¨ÏÑ±
                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                # [ROW 1] ÏãúÏû• Îç∞Ïù¥ÌÑ∞ (Market Data)
                                                                                                                                                                                                                                                                                                                                        st.subheader("1. Market Sensors")
                                                                                                                                                                                                                                                                                                                                                c1, c2, c3, c4 = st.columns(4)
                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                with c1:
                                                                                                                                                                                                                                                                                                                                                                            st.metric("TQQQ Price", f"${tqqq_now:.2f}", f"{tqqq_chg:.2f}%")
                                                                                                                                                                                                                                                                                                                                                                                    with c2:
                                                                                                                                                                                                                                                                                                                                                                                                st.metric("USD/KRW (ÌôòÏú®)", f"‚Ç©{usd_krw:.0f}")
                                                                                                                                                                                                                                                                                                                                                                                                        with c3:
                                                                                                                                                                                                                                                                                                                                                                                                                    # RSI ÏÉÅÌÉú ÌëúÏãú
                                                                                                                                                                                                                                                                                                                                                                                                                                rsi_label = "NORMAL"
                                                                                                                                                                                                                                                                                                                                                                                                                                            if rsi_now >= 80: rsi_label = "MADNESS"
                                                                                                                                                                                                                                                                                                                                                                                                                                                        elif rsi_now >= 75: rsi_label = "WARNING"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.metric("Weekly RSI (14)", f"{rsi_now:.1f}", rsi_label, delta_color="inverse")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            with c4:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # MDD ÏÉÅÌÉú ÌëúÏãú
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    mdd_label = "STABLE"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if mdd <= -50: mdd_label = "TOTAL WAR"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif mdd <= -20: mdd_label = "CRISIS"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.metric("MDD (Drawdown)", f"{mdd:.2f}%", mdd_label)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.divider()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # [ROW 2] CRO ÌåêÎã® (Decision Engine)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.subheader("2. CRO Action Protocol (Ver 9.1)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Î°úÏßÅ ÏóîÏßÑ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        final_action = ""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                bg_color = ""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if rsi_now >= 80:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bg_color = "red"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        final_action = "üö® [MADNESS] Í∞ïÎ†• Îß§ÎèÑ Í≤ΩÎ≥¥\n\n- TQQQ Îß§Ïàò Ï†àÎåÄ Í∏àÏßÄ\n- ÌòÑÍ∏à ÎπÑÏ§ë +10%p Ï∂îÍ∞Ä ÌôïÎ≥¥ (Í∞ïÏ†ú Îß§ÎèÑ)\n- Ï¶âÏãú CROÏóêÍ≤å Î≥¥Í≥†ÌïòÏãúÏò§."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif rsi_now >= 75:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bg_color = "orange"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        final_action = "‚ö†Ô∏è [WARNING] Í≥ºÏó¥ Í≤ΩÎ≥¥\n\n- TQQQ Îß§Ïàò Í∏àÏßÄ\n- Î™©Ìëú ÌòÑÍ∏à ÎπÑÏ§ë(30~50%)ÍπåÏßÄ Î¶¨Î∞∏Îü∞Ïã± Îß§ÎèÑ ÏàòÌñâ\n- CROÏóêÍ≤å Î≥¥Í≥†ÌïòÏãúÏò§."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif mdd <= -50:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bg_color = "green"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        final_action = "‚öîÔ∏è [TOTAL WAR] Ï†ÑÎ©¥Ï†Ñ ÏÑ†Ìè¨\n\n- Î≥¥Ïú† ÌòÑÍ∏à 100% Ìà¨ÏûÖ (All-In)\n- Ïù∏ÏÉù Ïó≠Ï†Ñ Íµ¨Í∞Ñ ÏßÑÏûÖ\n- CRO ÏäπÏù∏ ÌõÑ Ï¶âÏãú ÏßëÌñâ."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif mdd <= -30:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bg_color = "blue"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        final_action = "üõ°Ô∏è [CRISIS LV2] Í≥µÌè¨ Íµ¨Í∞Ñ\n\n- Î≥¥Ïú† ÌòÑÍ∏àÏùò 30% Ìà¨ÏûÖ\n- Í∏∞Í≥ÑÏ†Å Îß§Ïàò ÏàòÌñâ."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif mdd <= -20:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bg_color = "blue"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        final_action = "üõ°Ô∏è [CRISIS LV1] Ï°∞Ï†ï Íµ¨Í∞Ñ\n\n- Î≥¥Ïú† ÌòÑÍ∏àÏùò 20% Ìà¨ÏûÖ\n- 1Ï∞® Î∞©Ïñ¥ÏÑ† Íµ¨Ï∂ï."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bg_color = "gray"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        final_action = "‚úÖ [NORMAL] ÌèâÏãú Ïö¥Ïö©\n\n- Ïõî Ï†ÅÎ¶ΩÍ∏à(500ÎßåÏõê+) Ìà¨ÏûÖ\n- Ï†ïÍ∏∞ Î¶¨Î∞∏Îü∞Ïã±(ÌòÑÍ∏àÎπÑÏ§ë ÎßûÏ∂îÍ∏∞) ÏàòÌñâ\n- ÌäπÏù¥ÏÇ¨Ìï≠ ÏóÜÏùå."

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Í≤∞Í≥º Ï∂úÎ†• Î∞ïÏä§
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if bg_color == "red":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.error(final_action)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif bg_color == "orange":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.warning(final_action)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif bg_color == "green":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.success(final_action)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    elif bg_color == "blue":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.info(final_action)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.info(final_action)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.caption("‚Äª Ïù¥ ÌôîÎ©¥ÏùÑ Ï∫°Ï≤òÌïòÏó¨ Îß§Ïõî CRO(Gemini)ÏóêÍ≤å Ï†ÑÏÜ°ÌïòÏã≠ÏãúÏò§.")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                main()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                